<!doctype html><html lang=zh-tw dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Day 07：整合 tmux 和 zsh | Simba's Blog</title><meta name=keywords content="cli,terminal,software development,vim,tmux,zsh"><meta name=description content="昨天的結尾提到要整合 tmux 和 zsh 不是在 ~/.zshrc 結尾執行 tmux 這麼簡單，今天就讓我們看看會遇到什麼問題吧！
直接執行 tmux 在正式開始前，先讓我們看看直接在 ~/.zshrc 後面執行 tmux 會發生什麼錯誤
        直接執行 tmux    嗯，錯誤訊息說要 unset $TMUX 那我們就照作吧！
        加上 unset TMUX，嗯，爆炸了！    分析問題 可以看到，如果直接執行 tmux 的話總是會跳出一個錯誤 sessions should be nested with care, unset $TMUX to force，這段訊息告訴我們，不能建立巢狀 tmux，除非將 $TMUX 環境變數移除。欸？我們不是只執行一次 tmux 嗎？為什麼會他說我們建立巢狀 tmux？我們來看看登入之後發生了什麼事：
 執行 zsh（因為我們的 default shell 是 zsh） zsh 執行 ~/."><meta name=author content="simba-fs"><link rel=canonical href=https://blog.simba-fs.dev/posts/ithelp/day07/><link crossorigin=anonymous href=/assets/css/stylesheet.min.48a18943c2fc15c38a372b8dde1f5e5dc0bc64fa6cb90f5a817d2f8c76b7f3ae.css integrity="sha256-SKGJQ8L8FcOKNyuN3h9eXcC8ZPpsuQ9agX0vjHa3864=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.simba-fs.dev/images/icon/icon.png><link rel=icon type=image/png sizes=16x16 href=https://blog.simba-fs.dev/images/icon/icon-16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.simba-fs.dev/images/icon/icon-32.png><link rel=apple-touch-icon href=https://blog.simba-fs.dev/images/icon/icon.png><link rel=mask-icon href=https://blog.simba-fs.dev/images/icon/icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-175823992-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Day 07：整合 tmux 和 zsh"><meta property="og:description" content="昨天的結尾提到要整合 tmux 和 zsh 不是在 ~/.zshrc 結尾執行 tmux 這麼簡單，今天就讓我們看看會遇到什麼問題吧！
直接執行 tmux 在正式開始前，先讓我們看看直接在 ~/.zshrc 後面執行 tmux 會發生什麼錯誤
        直接執行 tmux    嗯，錯誤訊息說要 unset $TMUX 那我們就照作吧！
        加上 unset TMUX，嗯，爆炸了！    分析問題 可以看到，如果直接執行 tmux 的話總是會跳出一個錯誤 sessions should be nested with care, unset $TMUX to force，這段訊息告訴我們，不能建立巢狀 tmux，除非將 $TMUX 環境變數移除。欸？我們不是只執行一次 tmux 嗎？為什麼會他說我們建立巢狀 tmux？我們來看看登入之後發生了什麼事：
 執行 zsh（因為我們的 default shell 是 zsh） zsh 執行 ~/."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.simba-fs.dev/posts/ithelp/day07/"><meta property="og:image" content="https://blog.simba-fs.dev/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-07T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-07T00:00:00+00:00"><meta property="og:site_name" content="Simba 的喵窩"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.simba-fs.dev/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Day 07：整合 tmux 和 zsh"><meta name=twitter:description content="昨天的結尾提到要整合 tmux 和 zsh 不是在 ~/.zshrc 結尾執行 tmux 這麼簡單，今天就讓我們看看會遇到什麼問題吧！
直接執行 tmux 在正式開始前，先讓我們看看直接在 ~/.zshrc 後面執行 tmux 會發生什麼錯誤
        直接執行 tmux    嗯，錯誤訊息說要 unset $TMUX 那我們就照作吧！
        加上 unset TMUX，嗯，爆炸了！    分析問題 可以看到，如果直接執行 tmux 的話總是會跳出一個錯誤 sessions should be nested with care, unset $TMUX to force，這段訊息告訴我們，不能建立巢狀 tmux，除非將 $TMUX 環境變數移除。欸？我們不是只執行一次 tmux 嗎？為什麼會他說我們建立巢狀 tmux？我們來看看登入之後發生了什麼事：
 執行 zsh（因為我們的 default shell 是 zsh） zsh 執行 ~/."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"posts","item":"https://blog.simba-fs.dev/posts/"},{"@type":"ListItem","position":2,"name":"ithelp","item":"https://blog.simba-fs.dev/posts/ithelp/"},{"@type":"ListItem","position":3,"name":"Day 07：整合 tmux 和 zsh","item":"https://blog.simba-fs.dev/posts/ithelp/day07/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Day 07：整合 tmux 和 zsh","name":"Day 07：整合 tmux 和 zsh","description":"昨天的結尾提到要整合 tmux 和 zsh 不是在 ~/.zshrc 結尾執行 tmux 這麼簡單，今天就讓我們看看會遇到什麼問題吧！\n直接執行 tmux 在正式開始前，先讓我們看看直接在 ~/.zshrc 後面執行 tmux 會發生什麼錯誤\n        直接執行 tmux    嗯，錯誤訊息說要 unset $TMUX 那我們就照作吧！\n        加上 unset TMUX，嗯，爆炸了！    分析問題 可以看到，如果直接執行 tmux 的話總是會跳出一個錯誤 sessions should be nested with care, unset $TMUX to force，這段訊息告訴我們，不能建立巢狀 tmux，除非將 $TMUX 環境變數移除。欸？我們不是只執行一次 tmux 嗎？為什麼會他說我們建立巢狀 tmux？我們來看看登入之後發生了什麼事：\n 執行 zsh（因為我們的 default shell 是 zsh） zsh 執行 ~/.","keywords":["cli","terminal","software development","vim","tmux","zsh"],"articleBody":"昨天的結尾提到要整合 tmux 和 zsh 不是在 ~/.zshrc 結尾執行 tmux 這麼簡單，今天就讓我們看看會遇到什麼問題吧！\n直接執行 tmux 在正式開始前，先讓我們看看直接在 ~/.zshrc 後面執行 tmux 會發生什麼錯誤\n        直接執行 tmux    嗯，錯誤訊息說要 unset $TMUX 那我們就照作吧！\n        加上 unset TMUX，嗯，爆炸了！    分析問題 可以看到，如果直接執行 tmux 的話總是會跳出一個錯誤 sessions should be nested with care, unset $TMUX to force，這段訊息告訴我們，不能建立巢狀 tmux，除非將 $TMUX 環境變數移除。欸？我們不是只執行一次 tmux 嗎？為什麼會他說我們建立巢狀 tmux？我們來看看登入之後發生了什麼事：\n 執行 zsh（因為我們的 default shell 是 zsh） zsh 執行 ~/.zshrc，初始化終端機後執行 tmux tmux 開啟了新的 session，執行 default shell ~/.zshrc 又被執行一次，tmux 被執行第二次 如果你沒有 unset TMUX，那 tmux 就會停下來並印出錯誤訊息，你總共得到兩層 tmux\n如果你 unset TMUX，就是告訴 tmux 不管巢狀限制，就會回到第三步，你等越久會得到越多 tmux  看來問題在於 tmux 和 zsh 執行的迴圈停不下來，那我們就在執行 tmux 之前作個條件判斷，$TMUX 為空再執行 tmux 好了\n   ❓  $TMUX 是什麼     $TMUX 是一個環境變數，是一個由三個部份串起來、以逗號分開的字串，第一部份是 tmux 的 unix socket 路徑，第二部份是 tmux 的 pid，最後是目前 tmux window 的編號（左下角那個數字）。這個環境變數只有在 tmux 裡面的 session 會設定，所以可以當作 tmux 是否啟動的檢查    初步修改 我們在 ~/.zshrc 中執行 tmux 的那行做一些修改\n+ if [[ -z $TMUX ]];then tmux + fi  提示：-z $TMUX 和 $TMUX == \"\" 效果是一樣的\n 接下來我們看看這樣修改效果如何         先檢查 $TMUX 再執行 tmux    可以看到，巢狀 tmux 的算是問題解決了，但是你會發現離開 tmux 之後還是一個完整的 zsh，但是這時候你已經結束工作了，不需要再一個 shell，你希望關掉 tmux 之後應改關掉終端機視窗的，這又要怎麼辦呢？\n關掉多餘的 zsh  題外話，從這裡開始就是個人龜毛，想要把使用體驗調整到最好\n 這裡介紹一個內建指令 exec，這個指令會把當作的 shell 用後面的執行檔替換掉。例如我們現在的 shell 是 zsh，執行 exec ssh bbsu@ptt.cc 之後，我們的 shell 就會換成 ssh 了。這有什麼好處？簡單來說就是離開這個指令後就會離開終端機，不會再回到原本的 shell。這個效果剛好和我們的需求是一樣的，所以要解決多餘的 zsh，就只需要在 tmux 前面加上 exec\nif [[ -z $TMUX ]];then - tmux + exec tmux fi    ❓  exec cmd 和 cmd; exit 有什麼不一樣     這兩個寫法都會有一樣的效果 —— 結束 cmd 後離開，但是他們達成的原因不同，詳細敘述在 stackover flow 有相關討論，有興趣可以看看   你有可以用 htop 之類的工具看看 process 的結構，你就會知道 exec 和 exit 差別在哪了    改進 ~/.zshrc 我們回頭看看目前的 shell 啟動流程，你會發現雖然我們不會回到最初的 zsh，但是他卻做了一堆無意義的初始化、外掛載入，我們可以將這段設定納入 if 裡面，需要時才執行，如果只是要啟動 tmux 就不必走一遍設定 plugin 之類的流程，改進後的 ~/.zshrc 大概長這樣\nif [[ -z $$TMUX ]]; then  exec tmux else  # init zsh ...... fi 如此一來載入速度和記憶體用量都會有一咪咪的減少\n選擇性執行 tmux 有時候你可能會不想啟動 tmux，例如 ssh 到遠端主機，在遠端主機上啟動 tmux 而不是在本機上啟動（在本機上啟動的話要開很多 ssh 連線，在遠端啟動只要連線一次），這時候就要有一個機制可以把主機上的 tmux 關掉，回到原本的 shell，達成方法有很多，這裡我介紹一個我覺得最優雅的方法，在 ~/.zshrc 中 tmux 啟動判斷上加上以下條件\n- if [[ -z $TMUX ]]; then + if [[ -z $TMUX ]] \u0026\u0026 [[ ! -f $HOME/.notmux ]]; then 這時候 tmux 啟動條件就變成「tmux 還沒啟動」且「~/.notmux 不存在」，在這裡我們把 ~/.notmux 這個檔案當作一個開關，如果這個檔案存在 tmux 就不會啟動。\n如果你想啟動一個沒有 tmux 的終端機，先建立 ~/.notmux 檔案 touch ~/.notmux，然後開啟新的終端機\n結尾 今天的內容比較雜，修改的部份也比較零散，下面是目前 ~/.zshrc 的內容\nif [[ -z $TMUX ]] \u0026\u0026 [[ ! -f $HOME/.notmux ]]; then  exec tmux else  source ~/.zplug/init.zsh   # plugins  zplug 'romkatv/powerlevel10k', as:theme, depth:1  zplug 'zsh-users/zsh-autosuggestions'  zplug 'marlonrichert/zsh-autocomplete'  zplug 'hlissner/zsh-autopair'   if ! zplug check --verbose; then  printf \"Install? [y/N]: \"  if read -q; then  echo; zplug install  fi  fi   zplug load   # Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.  # Initialization code that may require console input (password prompts, [y/n]  # confirmations, etc.) must go above this block; everything else may go below.  if [[ -r \"${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh\" ]]; then  source \"${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh\"  fi  # To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.  [[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh   if [[ -z $TMUX ]]; then  tmux  exit  fi fi ","wordCount":"413","inLanguage":"zh-tw","datePublished":"2021-09-07T00:00:00Z","dateModified":"2021-09-07T00:00:00Z","author":{"@type":"Person","name":"simba-fs"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.simba-fs.dev/posts/ithelp/day07/"},"publisher":{"@type":"Organization","name":"Simba's Blog","logo":{"@type":"ImageObject","url":"https://blog.simba-fs.dev/images/icon/icon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.simba-fs.dev/ accesskey=h title="Home (Alt + H)"><img src=https://blog.simba-fs.dev/images/icon/icon.png alt=logo aria-label=logo height=35>Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://blog.simba-fs.dev/posts/ title=Categories><span>Categories</span></a></li><li><a href=https://blog.simba-fs.dev/archive/ title=Archives><span>Archives</span></a></li><li><a href=https://blog.simba-fs.dev/resource/ title=Resource><span>Resource</span></a></li><li><a href=https://blog.simba-fs.dev/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.simba-fs.dev/>首頁</a>&nbsp;»&nbsp;<a href=https://blog.simba-fs.dev/posts/>posts</a>&nbsp;»&nbsp;<a href=https://blog.simba-fs.dev/posts/ithelp/>ithelp</a></div><h1 class=post-title>Day 07：整合 tmux 和 zsh</h1><div class=post-meta><span title="2021-09-07 00:00:00 +0000 UTC">2021-September-7</span>&nbsp;·&nbsp;2 分鐘&nbsp;·&nbsp;simba-fs</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目錄</span></summary><div class=inner><ul><li><a href=#%e7%9b%b4%e6%8e%a5%e5%9f%b7%e8%a1%8c-tmux aria-label="直接執行 tmux">直接執行 tmux</a></li><li><a href=#%e5%88%86%e6%9e%90%e5%95%8f%e9%a1%8c aria-label=分析問題>分析問題</a></li><li><a href=#%e5%88%9d%e6%ad%a5%e4%bf%ae%e6%94%b9 aria-label=初步修改>初步修改</a></li><li><a href=#%e9%97%9c%e6%8e%89%e5%a4%9a%e9%a4%98%e7%9a%84-zsh aria-label="關掉多餘的 zsh">關掉多餘的 zsh</a></li><li><a href=#%e6%94%b9%e9%80%b2-zshrc aria-label="改進 ~/.zshrc">改進 <code>~/.zshrc</code></a></li><li><a href=#%e9%81%b8%e6%93%87%e6%80%a7%e5%9f%b7%e8%a1%8c-tmux aria-label="選擇性執行 tmux">選擇性執行 tmux</a></li><li><a href=#%e7%b5%90%e5%b0%be aria-label=結尾>結尾</a></li></ul></div></details></div><div class=post-content><p>昨天的結尾提到要整合 tmux 和 zsh 不是在 <code>~/.zshrc</code> 結尾執行 <code>tmux</code> 這麼簡單，今天就讓我們看看會遇到什麼問題吧！</p><h1 id=直接執行-tmux>直接執行 tmux<a hidden class=anchor aria-hidden=true href=#直接執行-tmux>#</a></h1><p>在正式開始前，先讓我們看看<strong>直接</strong>在 <code>~/.zshrc</code> 後面執行 <code>tmux</code> 會發生什麼錯誤</p><table><thead><tr><th style=text-align:center><img loading=lazy src=/images/ithelp/pure-CLI-IDE/day07/tmux-1.gif alt="tmux 1"></th></tr></thead><tbody><tr><td style=text-align:center>直接執行 <code>tmux</code></td></tr></tbody></table><p>嗯，錯誤訊息說要 unset $TMUX 那我們就照作吧！</p><table><thead><tr><th style=text-align:center><img loading=lazy src=/images/ithelp/pure-CLI-IDE/day07/tmux-reproduce.gif alt="tmux reproduce"></th></tr></thead><tbody><tr><td style=text-align:center>加上 unset TMUX，嗯，爆炸了！</td></tr></tbody></table><h1 id=分析問題>分析問題<a hidden class=anchor aria-hidden=true href=#分析問題>#</a></h1><p>可以看到，如果直接執行 <code>tmux</code> 的話總是會跳出一個錯誤 <code>sessions should be nested with care, unset $TMUX to force</code>，這段訊息告訴我們，不能建立<strong>巢狀</strong> tmux，除非將 $TMUX 環境變數移除。欸？我們不是只執行一次 tmux 嗎？為什麼會他說我們建立巢狀 tmux？我們來看看登入之後發生了什麼事：</p><ol><li>執行 zsh（因為我們的 <strong>default shell</strong> 是 zsh）</li><li>zsh 執行 <code>~/.zshrc</code>，初始化終端機後執行 <code>tmux</code></li><li>tmux 開啟了<strong>新的 session</strong>，<strong>執行 default shell</strong></li><li><code>~/.zshrc</code> 又被執行一次，<code>tmux</code> 被執行<strong>第二次</strong></li><li>如果你沒有 unset TMUX，那 tmux 就會<strong>停下來並印出錯誤訊息</strong>，你總共得到兩層 tmux<br>如果你 unset TMUX，就是告訴 tmux 不管巢狀限制，就會回到第三步，<strong>你等越久會得到越多 tmux</strong></li></ol><p>看來問題在於 tmux 和 zsh 執行的迴圈停不下來，那我們就在執行 tmux 之前作個<strong>條件判斷</strong>，$TMUX 為空再執行 <code>tmux</code> 好了</p><table><thead><tr><th style=text-align:left>❓ > $TMUX 是什麼</th></tr></thead><tbody><tr><td style=text-align:left>$TMUX 是一個環境變數，是一個由三個部份串起來、以逗號分開的字串，第一部份是 tmux 的 unix socket 路徑，第二部份是 tmux 的 pid，最後是目前 tmux window 的編號（左下角那個數字）。這個環境變數只有在 tmux 裡面的 session 會設定，所以可以當作 tmux 是否啟動的檢查</td></tr></tbody></table><h1 id=初步修改>初步修改<a hidden class=anchor aria-hidden=true href=#初步修改>#</a></h1><p>我們在 <code>~/.zshrc</code> 中執行 <code>tmux</code> 的那行做一些修改</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a6e22e>+ if [[ -z $TMUX ]];then
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>tmux
</span></span><span style=display:flex><span><span style=color:#a6e22e>+ fi
</span></span></span></code></pre></div><blockquote><p>提示：<code>-z $TMUX</code> 和 <code>$TMUX == ""</code> 效果是一樣的</p></blockquote><p>接下來我們看看這樣修改效果如何</p><table><thead><tr><th style=text-align:center><img loading=lazy src=/images/ithelp/pure-CLI-IDE/day07/tmux-2.gif alt="tmux 2"></th></tr></thead><tbody><tr><td style=text-align:center>先檢查 $TMUX 再執行 <code>tmux</code></td></tr></tbody></table><p>可以看到，巢狀 tmux 的算是問題解決了，但是你會發現離開 tmux 之後還是一個完整的 zsh，但是這時候你已經結束工作了，<strong>不需要再一個 shell</strong>，你希望關掉 tmux 之後應改關掉終端機視窗的，這又要怎麼辦呢？</p><h1 id=關掉多餘的-zsh>關掉多餘的 zsh<a hidden class=anchor aria-hidden=true href=#關掉多餘的-zsh>#</a></h1><blockquote><p>題外話，從這裡開始就是個人龜毛，想要把使用體驗調整到最好</p></blockquote><p>這裡介紹一個內建指令 <code>exec</code>，這個指令會把當作的 shell <strong>用後面的執行檔替換掉</strong>。例如我們現在的 shell 是 zsh，執行 <code>exec ssh bbsu@ptt.cc</code> 之後，我們的 shell 就會換成 ssh 了。這有什麼好處？簡單來說就是<strong>離開這個指令後就會離開終端機</strong>，不會再回到原本的 shell。這個效果剛好和我們的需求是一樣的，所以要解決多餘的 zsh，就只需要在 <code>tmux</code> 前面加上 <code>exec</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>if [[ -z $TMUX ]];then
</span></span><span style=display:flex><span><span style=color:#f92672>- tmux
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+ exec tmux
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>fi
</span></span></code></pre></div><table><thead><tr><th style=text-align:left>❓ > <code>exec cmd</code> 和 <code>cmd; exit</code> 有什麼不一樣</th></tr></thead><tbody><tr><td style=text-align:left>這兩個寫法都會有一樣的效果 —— 結束 cmd 後離開，但是他們達成的原因不同，詳細敘述在 <a href=https://stackoverflow.com/questions/8874596/difference-between-exec-and-exit-in-bash>stackover flow</a> 有相關討論，有興趣可以看看</td></tr><tr><td style=text-align:left>你有可以用 <code>htop</code> 之類的工具看看 process 的結構，你就會知道 <code>exec</code> 和 <code>exit</code> 差別在哪了</td></tr></tbody></table><h1 id=改進-zshrc>改進 <code>~/.zshrc</code><a hidden class=anchor aria-hidden=true href=#改進-zshrc>#</a></h1><p>我們回頭看看目前的 shell 啟動流程，你會發現雖然我們不會回到最初的 zsh，但是他卻做了一堆<strong>無意義的</strong>初始化、外掛載入，我們可以將這段設定<strong>納入 if</strong> 裡面，需要時才執行，如果只是要啟動 tmux 就不必走一遍設定 plugin 之類的流程，改進後的 <code>~/.zshrc</code> 大概長這樣</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -z $$TMUX <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    exec tmux
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># init zsh ......</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><p>如此一來載入速度和記憶體用量都會有一咪咪的減少</p><h1 id=選擇性執行-tmux>選擇性執行 tmux<a hidden class=anchor aria-hidden=true href=#選擇性執行-tmux>#</a></h1><p>有時候你可能會<strong>不想啟動 tmux</strong>，例如 ssh 到遠端主機，在遠端主機上啟動 tmux 而不是在本機上啟動（在本機上啟動的話要開很多 ssh 連線，在遠端啟動只要連線一次），這時候就要有<strong>一個機制可以把主機上的 tmux 關掉</strong>，回到原本的 shell，達成方法有很多，這裡我介紹一個我覺得最優雅的方法，在 <code>~/.zshrc</code> 中 tmux 啟動判斷上加上以下條件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>- if [[ -z $TMUX ]]; then
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+ if [[ -z $TMUX ]] &amp;&amp; [[ ! -f $HOME/.notmux  ]]; then
</span></span></span></code></pre></div><p>這時候 tmux 啟動條件就變成「tmux 還沒啟動」且「<code>~/.notmux</code> 不存在」，在這裡我們把 <code>~/.notmux</code> 這個檔案當作一個開關，如果這個檔案存在 tmux 就不會啟動。</p><p>如果你想啟動一個沒有 tmux 的終端機，先建立 <code>~/.notmux</code> 檔案 <code>touch ~/.notmux</code>，然後開啟新的終端機</p><h1 id=結尾>結尾<a hidden class=anchor aria-hidden=true href=#結尾>#</a></h1><p>今天的內容比較雜，修改的部份也比較零散，下面是目前 <code>~/.zshrc</code> 的內容</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -z $TMUX <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>[[</span> ! -f $HOME/.notmux  <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    exec tmux
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    source ~/.zplug/init.zsh
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># plugins</span>
</span></span><span style=display:flex><span>    zplug <span style=color:#e6db74>&#39;romkatv/powerlevel10k&#39;</span>, as:theme, depth:1
</span></span><span style=display:flex><span>    zplug <span style=color:#e6db74>&#39;zsh-users/zsh-autosuggestions&#39;</span>
</span></span><span style=display:flex><span>    zplug <span style=color:#e6db74>&#39;marlonrichert/zsh-autocomplete&#39;</span>
</span></span><span style=display:flex><span>    zplug <span style=color:#e6db74>&#39;hlissner/zsh-autopair&#39;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! zplug check --verbose; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        printf <span style=color:#e6db74>&#34;Install? [y/N]: &#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> read -q; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            echo; zplug install
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    zplug load
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Initialization code that may require console input (password prompts, [y/n]</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># confirmations, etc.) must go above this block; everything else may go below.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -r <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>XDG_CACHE_HOME<span style=color:#66d9ef>:-</span>$HOME/.cache<span style=color:#e6db74>}</span><span style=color:#e6db74>/p10k-instant-prompt-</span><span style=color:#e6db74>${</span>(%)<span style=color:#66d9ef>:-</span>%n<span style=color:#e6db74>}</span><span style=color:#e6db74>.zsh&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>      source <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>XDG_CACHE_HOME<span style=color:#66d9ef>:-</span>$HOME/.cache<span style=color:#e6db74>}</span><span style=color:#e6db74>/p10k-instant-prompt-</span><span style=color:#e6db74>${</span>(%)<span style=color:#66d9ef>:-</span>%n<span style=color:#e6db74>}</span><span style=color:#e6db74>.zsh&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>[[</span> ! -f ~/.p10k.zsh <span style=color:#f92672>]]</span> <span style=color:#f92672>||</span> source ~/.p10k.zsh
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -z $TMUX <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        tmux
</span></span><span style=display:flex><span>        exit
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.simba-fs.dev/tags/cli/>cli</a></li><li><a href=https://blog.simba-fs.dev/tags/terminal/>terminal</a></li><li><a href=https://blog.simba-fs.dev/tags/software-development/>software development</a></li><li><a href=https://blog.simba-fs.dev/tags/vim/>vim</a></li><li><a href=https://blog.simba-fs.dev/tags/tmux/>tmux</a></li><li><a href=https://blog.simba-fs.dev/tags/zsh/>zsh</a></li></ul><nav class=paginav><a class=prev href=https://blog.simba-fs.dev/posts/ithelp/day08/><span class=title>« 上一篇</span><br><span>Day 08：八爪章魚之 tmux 快捷鍵</span></a>
<a class=next href=https://blog.simba-fs.dev/posts/ithelp/day06/><span class=title>下一篇 »</span><br><span>Day 06：螢幕切八段！多開神器 tmux</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.simba-fs.dev/>Simba's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>